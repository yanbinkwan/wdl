<!DOCTYPE html>
<html>

<head>
  <title>Parcel Sandbox</title>
  <meta charset="UTF-8" />
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7.7.0/+esm";
    import { items } from "./items.js";
    import Node from './node.js'

    const height = 200;
    const width = 200;
    const radius = 2.5;

    const circles = [
      {
        id: 1, x: 50, y: 50,
        inputs: [],
        outputs: [
          { id: 1, link: null, x: 20.2, r: 1.4 },
          { id: 1, link: null, x: 20.2, r: 1.4 }]
      },
      {
        id: 2, x: 150, y: 90,
        inputs: [
          { id: 2, r: 1.4, x: 0, source: {}, target: {}, },
          { id: 2, r: 1.4, x: 0, source: {}, target: {} },
          { id: 2, r: 1.4, x: 0, source: {}, target: {} }],
        outputs: [{ id: 2, link: null, x: 20.2, r: 1.4 }]
      },
      {
        id: 4, x: 140, y: 60,
        inputs: [
          { id: 4, r: 1.4, x: 0, source: {}, target: {}, },
          { id: 4, r: 1.4, x: 0, source: {}, target: {} },
          { id: 4, r: 1.4, x: 0, source: {}, target: {} }],
        outputs: [{ id: 4, link: null, x: 20.2, r: 1.4 }]
      }
    ];

    document.getElementById("app").appendChild(chart());

    function chart() {
      const svg = d3
        .create("svg")
        .attr("class", "svg-box")
        .attr("viewBox", [0, 0, width, height])
        .attr("stroke-width", 2)
        .on('ondrop', ev => {
          ev.preventDefault();
          ev.dataTransfer.dropEffect = "move";
          // Get the id of the target and add the moved element to the target's DOM
          // const data = ev.dataTransfer.getData("text/plain");
          // ev.target.appendChild(document.getElementById(data));
        })
        .on('dragover', ev => {
          ev.preventDefault();
        })

      svg.call(Node().data(circles))

      d3.select("#app").call(items().on('dragend-g', (value) => {
        const { x, y } = value;
        const svgnode = d3.select('.svg-box').node();
        const pt = svgnode.createSVGPoint();

        pt.x = x;
        pt.y = y;
        const svgP = pt.matrixTransform(svgnode.getScreenCTM().inverse());

        // svg.append('rect')
        //   .attr('width', 20)
        //   .attr('height', 20).attr('x', svgP.x).attr('y', svgP.y).attr('fill', 'black')

        circles.push({
          id: 6, x: svgP.x, y: svgP.y,
          inputs: [],
          outputs: [
            { id: 6, link: null, x: 20.2, r: 1.4 },
            { id: 6, link: null, x: 20.2, r: 1.4 }]
        },)
        svg.call(Node().data(circles))
      }));
      return svg.node();
    }

  </script>
</body>

</html>